# Upgrade Notes - Docker Compose Best Practices Implementation

## Overview

This document describes the major refactoring implemented to align with Docker Compose best practices, simplify the codebase, and improve maintainability.

## Key Changes

### 1. Docker Compose Project Name Approach ⭐

**Before:** Manual prefixes in every file (`${IMAGES_PREFIX:-}-app-php`, container names, volume names)

**After:** Uses `COMPOSE_PROJECT_NAME` environment variable for automatic namespacing

**Benefits:**
- ✅ Automatic prefixing of ALL Docker resources (containers, volumes, networks)
- ✅ No file modifications needed
- ✅ Official Docker best practice
- ✅ Cleaner, more maintainable code
- ✅ Easier to understand and debug

**Example:**
```bash
# Set in .env or export
COMPOSE_PROJECT_NAME=invoice-app

# Automatically creates:
# - invoice-app-php-1 (container)
# - invoice-app-database-1 (container)
# - invoice-app_db_data (volume)
# - invoice-app_default (network)
```

### 2. Simplified compose.yaml

**Removed:**
- Manual `container_name` declarations
- `${IMAGES_PREFIX}` prefix patterns
- Build section (moved to override for dev)
- Hardcoded Mercure configuration

**Added:**
- Clean service definitions
- Optional Mercure configuration (commented out)
- Better documentation

**Before:**
```yaml
php:
  image: ${IMAGES_PREFIX:-}-app-php
  container_name: ${IMAGES_PREFIX:-}-php-app
```

**After:**
```yaml
php:
  image: app-php
  # Container name auto-generated by COMPOSE_PROJECT_NAME
```

### 3. Mercure Made Optional

**Rationale:** Most projects don't need real-time messaging from day one.

**Implementation:**
- Mercure environment variables are now commented out
- Easy to enable by uncommenting when needed
- Reduces complexity for new projects
- Follows "you ain't gonna need it" principle

**To Enable Mercure:**
1. Uncomment Mercure lines in [`compose.yaml`](compose.yaml:15-19)
2. Uncomment Mercure lines in [`.env`](.env:38-40)
3. Run `composer require symfony/mercure-bundle`

### 4. Updated Setup Scripts

**setup.sh Changes:**
- Clearer messaging about Docker Compose project naming
- Simplified port configuration prompts
- Better error handling
- No more manual file sed operations for container names

**setup2.sh Changes:**
- Now exports `COMPOSE_PROJECT_NAME` instead of modifying files
- Creates `.env` file with proper project configuration
- Simplified database wait logic
- Better progress reporting
- All Docker commands use automatic namespacing

### 5. New Makefile for Convenience

Added [`Makefile`](Makefile:1) with common commands:

```bash
make help      # Show available commands
make up        # Start services
make down      # Stop services
make logs      # View logs
make shell     # Access PHP container
make console   # Run Symfony console commands
make cc        # Clear cache
# ... and many more
```

**Usage Example:**
```bash
# Run a Symfony command
make console cmd="cache:clear"

# Access database
make db-shell
```

### 6. Updated Configuration Files

**.env:**
- Added `COMPOSE_PROJECT_NAME` variable
- Made Mercure optional (commented out)
- Better documentation
- Clearer structure

**.env.dev.example:**
- Made Mercure optional
- Better comments explaining service names vs host access
- Clearer database connection documentation

**compose.override.yaml:**
- Simplified port mappings for mailpit
- Made Mercure demo mode optional
- Cleaner structure

## Migration Guide

### For Existing Projects

If you have an existing project using the old approach:

1. **Set Project Name:**
   ```bash
   echo "COMPOSE_PROJECT_NAME=your-project-name" >> .env
   ```

2. **Stop Existing Containers:**
   ```bash
   docker compose down
   ```

3. **Pull Latest Changes:**
   ```bash
   git pull origin main
   ```

4. **Rebuild and Start:**
   ```bash
   docker compose build --no-cache
   docker compose up -d
   ```

5. **Verify:**
   ```bash
   docker compose ps
   # Should show containers with your-project-name prefix
   ```

### For New Projects

Simply run the setup script:
```bash
cd setup
./setup.sh
```

The script will:
1. Clone the template
2. Set up `COMPOSE_PROJECT_NAME` automatically
3. Configure all services
4. No manual file editing needed!

## Breaking Changes

### Container Names
- **Old:** Manually specified with prefixes
- **New:** Auto-generated by Docker Compose
- **Impact:** If you have scripts referencing specific container names, update them to use service names instead:
  ```bash
  # Old
  docker exec my-prefix-php-app php bin/console cache:clear
  
  # New (recommended)
  docker compose exec php php bin/console cache:clear
  ```

### Volume Names
- **Old:** `${IMAGES_PREFIX}_database_volume`
- **New:** `db_data` (auto-prefixed by COMPOSE_PROJECT_NAME)
- **Impact:** Existing volumes won't be automatically migrated. Export data first if needed.

### Environment Variables
- **Removed:** `IMAGES_PREFIX`
- **Added:** `COMPOSE_PROJECT_NAME`
- **Impact:** Update any scripts or documentation

## Advantages of New Approach

### 1. Cleaner Code
- No more `${IMAGES_PREFIX:-}` scattered everywhere
- More readable compose files
- Easier to understand for newcomers

### 2. Better Maintainability
- Less sed operations = fewer places for bugs
- Standard Docker approach = easier to debug
- Fewer custom patterns to remember

### 3. Easier Updates
- Template can be updated without merge conflicts
- Compose file structure matches official examples
- Better compatibility with Docker tools

### 4. Flexibility
- Easy to run multiple projects simultaneously
- Simple port customization
- Optional features (like Mercure) are truly optional

## Testing Checklist

After upgrading, test these scenarios:

- [ ] `docker compose up -d` starts all services
- [ ] Containers have correct project prefix
- [ ] Volumes persist data correctly
- [ ] Database connection works
- [ ] Mailpit receives emails
- [ ] Symfony console commands work: `docker compose exec php bin/console`
- [ ] Assets build correctly [if using Encore]
- [ ] Multiple projects can run simultaneously [with different ports]
- [ ] Makefile commands work: `make help`, `make shell`, etc.

## Dockerfile Improvements

While refactoring, we also applied critical Docker file improvements:

1. **Added missing environment variables:**
   - `MERCURE_TRANSPORT_URL`
   - `PHP_INI_SCAN_DIR`

2. **Fixed production stage:**
   - Uses `--exclude=frankenphp/` to avoid file duplication
   - Added `composer dump-env prod` for better performance
   - Added `chmod +x bin/console`
   - Better file copy patterns

3. **Added Symfony Flex recipe markers:**
   - Allows Flex to inject Docker configuration

4. **Better configuration file handling:**
   - Proper order of operations
   - Correct permissions

## Support

For issues or questions about this upgrade:

1. Check `docker compose logs` for errors
2. Verify `.env` has `COMPOSE_PROJECT_NAME` set
3. Ensure ports aren't conflicting
4. Review this document's migration guide

## References

- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Symfony Docker Official Repo](https://github.com/dunglas/symfony-docker)
- [Docker Compose Project Name](https://docs.docker.com/compose/project-name/)